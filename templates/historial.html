{% extends "layout.html" %}

{% block contenido %}

<h1>Historial de Préstamos</h1>

<!-- FILTROS -->
<div class="filtros-box">
    <form method="GET" class="filtros-grid">

        <div>
            <label>Mecánico</label>
            <select name="mecanico">
                <option value="">-- Todos --</option>
                {% for m in mecanicos %}
                <option value="{{ m.id }}" {% if filtros.mecanico == m.id|string %}selected{% endif %}>
                    {{ m.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label>Herramienta</label>
            <select name="herramienta">
                <option value="">-- Todas --</option>
                {% for h in herramientas %}
                <option value="{{ h.id }}" {% if filtros.herramienta == h.id|string %}selected{% endif %}>
                    {{ h.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label>Fecha</label>
            <input type="date" name="fecha" value="{{ filtros.fecha }}">
        </div>

        <div class="btn-box">
            <button class="btn" type="submit" style="width:100%;">Filtrar</button>
        </div>

    </form>
</div>

<hr>

<!-- TABLA -->
<table class="tabla-historial">
    <thead>
        <tr>
            <th>Herramienta</th>
            <th>Mecánico</th>
            <th>Inicio</th>
            <th>Devolución</th>
            <th>Tiempo de Uso</th>
        </tr>
    </thead>

    <tbody>
        {% for p in prestamos.items %}
        <tr>
            <td>{{ p.herramienta.nombre }}</td>
            <td>{{ p.mecanico.nombre }}</td>
            <td>{{ p.fecha_prestamo.strftime('%d/%m/%Y %H:%M') }}</td>

            <td>
                {% if p.fecha_devolucion %}
                    {{ p.fecha_devolucion.strftime('%d/%m/%Y %H:%M') }}
                {% else %}
                    <span class="badge badge-prestada">En uso</span>
                {% endif %}
            </td>

            <td>
                {% if p.tiempo_uso is not none %}
                    {{ p.tiempo_uso }} min
                {% else %}
                    En uso
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- PAGINACIÓN -->
<div class="paginacion">
    {% if prestamos.has_prev %}
        <a class="btn" href="?page={{ prestamos.prev_num }}{% if filtros.mecanico %}&mecanico={{ filtros.mecanico }}{% endif %}{% if filtros.herramienta %}&herramienta={{ filtros.herramienta }}{% endif %}{% if filtros.fecha %}&fecha={{ filtros.fecha }}{% endif %}">Anterior</a>
    {% endif %}

    {% if prestamos.has_next %}
        <a class="btn" href="?page={{ prestamos.next_num }}{% if filtros.mecanico %}&mecanico={{ filtros.mecanico }}{% endif %}{% if filtros.herramienta %}&herramienta={{ filtros.herramienta }}{% endif %}{% if filtros.fecha %}&fecha={{ filtros.fecha }}{% endif %}">Siguiente</a>
    {% endif %}
</div>

{% endblock %}